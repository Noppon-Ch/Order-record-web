<%- include('../../../shared/views/partials/app-header') %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8 animate-fade-in-up">

        <div class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">อนุมัติสมาชิกเข้าทีม</h1>
            <p class="mt-2 text-sm text-gray-500">ตรวจสอบและกำหนดข้อมูลอ้างอิงยืนยันตัวตนสำหรับสมาชิก</p>
        </div>

        <% if (typeof error !=='undefined' && error) { %>
            <div class="rounded-md bg-red-50 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <!-- Heroicon name: solid/x-circle -->
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">
                            พบข้อผิดพลาด
                        </h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>
                                <%= error %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>

                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 bg-gray-50">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">ข้อมูลสมาชิก</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">รายละเอียดพื้นฐานของสมาชิกที่ต้องการอนุมัติ</p>
                    </div>
                    <div class="border-t border-gray-200">
                        <dl>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">ชื่อ-นามสกุล</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <%= member.user_profile?.user_full_name || '-' %>
                                </dd>
                            </div>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">อีเมล</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <%= member.user_profile?.user_email || '-' %>
                                </dd>
                            </div>
                            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">บทบาท</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        member
                                    </span>
                                </dd>
                            </div>
                            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                <dt class="text-sm font-medium text-gray-500">สถานะ</dt>
                                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        active
                                    </span>
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>

                <form id="approveMemberForm" class="mt-8 space-y-8 divide-y divide-gray-200">
                    <input type="hidden" name="memberId" value="<%= member.id %>">

                    <div class="bg-white shadow sm:rounded-lg overflow-hidden">
                        <div class="px-4 py-5 sm:px-6 bg-indigo-50 border-b border-indigo-100">
                            <h3 class="text-lg leading-6 font-medium text-indigo-900">ข้อมูลอ้างอิง (Reference)</h3>
                            <p class="mt-1 text-sm text-indigo-700">ระบุข้อมูลลูกค้าที่เชื่อมโยงกับบัญชีผู้ใช้นี้</p>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-4">
                                    <label for="customer_name" class="block text-sm font-medium text-gray-700">
                                        ชื่อ-นามสกุล (ลูกค้าอ้างอิง) <span class="text-red-500">*</span>
                                    </label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" name="customer_name" id="customer_name" readonly
                                            class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md border border-gray-300 bg-gray-50 text-gray-500 sm:text-sm"
                                            placeholder="กรุณาค้นหาข้อมูลลูกค้า">
                                        <button type="button" id="openSearchModalBtn"
                                            class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 rounded-r-md bg-indigo-50 text-indigo-700 hover:bg-indigo-100 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                            </svg>
                                            <span class="ml-2">ค้นหา</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="sm:col-span-4">
                                    <label for="customerId" class="block text-sm font-medium text-gray-700">
                                        Customer ID (UUID) <span class="text-red-500">*</span>
                                    </label>
                                    <div class="mt-1">
                                        <input type="text" name="customerId" id="customerId" readonly required
                                            class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md bg-gray-50 text-gray-500 font-mono">
                                    </div>
                                    <p class="mt-2 text-xs text-gray-500">
                                        รหัสอ้างอิงในระบบ (เติมอัตโนมัติเมื่อเลือกข้อมูลค้นหา)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-5">
                        <div class="flex justify-end">
                            <a href="/teams"
                                class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                ยกเลิก
                            </a>
                            <button type="submit" id="submitApproveBtn"
                                class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                ยืนยันอนุมัติ
                            </button>
                        </div>
                    </div>
                </form>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                id="closeSearchModalOverlay">
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6 relative z-10">
                <div>
                    <div class="mt-3 text-center sm:mt-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">ค้นหาข้อมูลลูกค้า
                        </h3>
                        <div class="mt-2">
                            <input type="text" id="searchInput"
                                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border"
                                placeholder="ระบุชื่อ หรือ เลขบัตรประชาชน...">
                            <button type="button" id="performSearchBtn"
                                class="mt-2 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:text-sm">
                                ค้นหา
                            </button>
                        </div>
                        <div class="mt-4 text-left max-h-60 overflow-y-auto" id="searchResults">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6">
                    <button type="button" id="closeSearchModalBtn"
                        class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:text-sm">
                        ปิด
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script nonce="<%= (typeof nonce !== 'undefined' ? nonce : '') %>">
        document.addEventListener('DOMContentLoaded', () => {
            // Search Modal Logic
            const openSearchBtn = document.getElementById('openSearchModalBtn');
            const closeSearchBtn = document.getElementById('closeSearchModalBtn');
            const closeSearchOverlay = document.getElementById('closeSearchModalOverlay');
            const searchModal = document.getElementById('searchModal');
            const performSearchBtn = document.getElementById('performSearchBtn');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');

            const customerNameInput = document.getElementById('customer_name');
            const customerIdInput = document.getElementById('customerId');

            function openModal() {
                if (searchModal) {
                    searchModal.classList.remove('hidden');
                    if (searchInput) searchInput.focus();
                }
            }

            function closeModal() {
                if (searchModal) searchModal.classList.add('hidden');
            }

            if (openSearchBtn) openSearchBtn.addEventListener('click', openModal);
            if (closeSearchBtn) closeSearchBtn.addEventListener('click', closeModal);
            if (closeSearchOverlay) closeSearchOverlay.addEventListener('click', closeModal);

            if (searchInput) {
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
            }

            if (performSearchBtn) performSearchBtn.addEventListener('click', performSearch);

            async function performSearch() {
                const query = searchInput.value.trim();
                if (!query) return;

                searchResults.innerHTML = '<div class="flex justify-center py-4"><svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

                try {
                    const response = await fetch(`/customer/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    searchResults.innerHTML = '';

                    if (data.length === 0) {
                        searchResults.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">ไม่พบข้อมูล</p>';
                        return;
                    }

                    const ul = document.createElement('ul');
                    ul.className = 'divide-y divide-gray-200';

                    data.forEach(customer => {
                        const li = document.createElement('li');
                        li.className = 'py-3 flex justify-between items-center cursor-pointer hover:bg-gray-50 px-2 rounded-md transition-colors duration-150';
                        li.addEventListener('click', () => selectCustomer(customer));

                        li.innerHTML = `
                            <div class="text-sm">
                                <p class="font-bold text-gray-900">${customer.customer_fname_th} ${customer.customer_lname_th}</p>
                                <p class="text-gray-500 text-xs mt-0.5">ID: ${customer.customer_citizen_id}</p>
                            </div>
                            <button type="button" class="ml-4 bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1 rounded-md text-xs font-medium hover:bg-indigo-100">เลือก</button>
                        `;
                        ul.appendChild(li);
                    });

                    searchResults.appendChild(ul);

                } catch (error) {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<p class="text-sm text-red-500 text-center">เกิดข้อผิดพลาดในการค้นหา</p>';
                }
            }

            function selectCustomer(customer) {
                if (customerNameInput) customerNameInput.value = `${customer.customer_fname_th} ${customer.customer_lname_th}`;
                // Link actual customer_id (UUID)
                if (customerIdInput) customerIdInput.value = customer.customer_id;

                closeModal();
            }

            // Submit Form with SweetAlert
            const form = document.getElementById('approveMemberForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const memberId = form.elements['memberId'].value;
                    const customerId = form.elements['customerId'].value;

                    if (!customerId) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณาระบุข้อมูลอ้างอิง',
                            text: 'จำเป็นต้องค้นหาและเลือกข้อมูลลูกค้าเพื่อดำเนินการต่อ'
                        });
                        return;
                    }

                    const confirmed = await Swal.fire({
                        title: 'ยืนยันการอนุมัติ?',
                        text: "คุณตรวจสอบข้อมูลครบถ้วนแล้วใช่หรือไม่?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#4f46e5',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'ใช่, อนุมัติ',
                        cancelButtonText: 'ยกเลิก'
                    });

                    if (confirmed.isConfirmed) {
                        try {
                            const response = await fetch('/teams/approve', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ memberId, customerId })
                            });
                            const result = await response.json();

                            if (result.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'สำเร็จ!',
                                    text: 'อนุมัติสมาชิกเรียบร้อยแล้ว',
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    window.location.href = '/teams'; // Redirect back to team page
                                });
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: error.message || 'Failed to approve member'
                            });
                        }
                    }
                });
            }
        });
    </script>
    <%- include('../../../shared/views/partials/app-footer') %>